<!doctype html>
<html lang="en">
  <head>
    <title>Lista Veicoli</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">

    <style>
        body {
            background-image: url('background.jpg');
            background-size: cover;
            background-repeat: no-repeat;
        }
        /* Navbar verticale */
        .navbar {
            height: 100vh;
            position: fixed;
            top: 0;
            left: 0;
            background-color: yellow;
            padding-top: 20px;
            width: 100px;
        }
        .navbar a {
            display: block;
            color: black;
            text-align: center;
            padding: 16px;
            text-decoration: none;
            margin-bottom: 20px;
        }
        .navbar a:hover {
            background-color: #ddd;
        }
        .icon {
            width: 40px;
            height: auto;
        }
        .car-icon.selected {
            border: 2px solid gray; /* Cambia lo stile per indicare selezione */
        }
        .unavailable {
          opacity: 0.3; /* Opacità ridotta per le colonnine non disponibili */
          pointer-events: none; /* Disabilita i click sulle colonnine non disponibili */
        }
        .available {
          opacity: 1; /* Opacità ridotta per le colonnine non disponibili */
        }
        .content {
            margin-left: 120px; /* Spazio per la navbar */
            padding: 20px;
        }
        /* Stile della lista dati */
        .data-list {
            background-color: rgba(255, 255, 255, 0.528);
            padding: 20px;
            border-radius: 10px;
        }
       /* CSS per la lista */
       .table-responsive {
        width: 100%;
        overflow-x: auto; /* Aggiungi lo scroll orizzontale se necessario */
        }
        .table-striped tr {
            border-bottom: 1px solid #ccc; /* Righe di separazione */
        }
        @media (max-width: 768px) {
        .table td, .table th {
        padding: 8px; /* Riduce il padding per le celle */
        font-size: 14px; /* Riduce la dimensione del testo */
        }
        }

        @media (max-width: 576px) {
        .table td, .table th {
        padding: 6px;
        font-size: 12px; /* Ulteriore riduzione della dimensione del testo */
        }}

        td, th {
            padding: 10px;
            text-align: left;
            vertical-align: middle;
        }

        th {
            font-weight: bold;
            background-color: #f5f5f596;
        }

        .container {
            margin-top: 20px;
        }
    </style>
  </head>
  <body>
    <!--Banner di errore comunicazione database
    <div id="errorBanner" style="display:none; background-color:red; color:white; padding:10px; z-index: 1051; position: fixed; top: 0; width: 100%;">
        <span id="errorMessage"></span>
      </div>-->
    <!-- Navbar verticale con icone -->
    <div class="navbar">
        <a href="targhe_prove.html"><img src="home.png" alt="Icon 1" class="icon"></a>
        <a href="list.html"><img src="list_icon.png" alt="Icon 2" class="icon"></a>
        <a href=""><img src="charging-station.png" alt="Icon 3" class="icon"></a>
    </div>

    <!-- Contenuto principale -->
    <div class="container">
        <h1>Lista Veicoli</h1>
        <div class="data-list" id="dataList">
            <div class="table-responsive">
            <!-- I dati verranno inseriti qui tramite AJAX -->
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>Nome</th>
                        <th>Targa</th>
                        <th>Inizio</th>
                        <th>Fine</th>
                        <th>Colonnina</th>
                        <th>Modifica</th>
                    </tr>
                </thead>
                <tbody id="dataList">
                    <!-- Gli elementi verranno aggiunti qui con Ajax -->
                </tbody>
            </table>
        </div>
        </div>
    </div>
    

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        function fetchData() {
            $.ajax({
                type: 'POST',
                url: '/lista', 
                success: function(response) {
                    var dataList = $('#dataList');
                    dataList.empty();
                    let date1,date2;
                    if(response.error){
                        $('#errorBanner').text(response.error).show();
                        return;
                    }
                    $('#errorBanner').text(response.error).show();
                    response.forEach(function(item) {
                        var listItem = $('<tr></tr>');                    
                        date1 = new Date(item.Inizio).toISOString().split('T')[0];
                        date2 = new Date(item.Fine).toISOString().split('T')[0];
                        listItem.append('<td>' + item.Nome + '</td>');
                        listItem.append('<td>' + item.Targa + '</td>');
                        listItem.append('<td>' + date1 + '</td>'); 
                        listItem.append('<td>' + date2 + '</td>'); 
                        listItem.append('<td>' + item.Colonnine + '</td>');
                        var button = $('<button></button>').addClass('btn btn-primary');
                        button.attr({
                        'type': 'button',
                        'class': 'btn btn-link',
                        'data-bs-toggle': 'modal',
                        'data-bs-target': '#editModal'
                        });
                        button.attr('data-nome', item.Nome);
                        button.attr('data-targa', item.Targa);
                        button.attr('data-inizio', date1);
                        button.attr('data-fine', date2);
                        button.attr('data-colonnina', item.Colonnine);

                        button.on('click', function() {
                            $('#modalNome').val($(this).attr('data-nome'));
                            $('#modalTarga').val($(this).attr('data-targa'));
                            $('#modalInizio').val($(this).attr('data-inizio'));
                            $('#modalFine').val($(this).attr('data-fine'));
                            $('#modalColonnina').val($(this).attr('data-colonnina'));
                            selectCar(item.Colonnine);
                        });
                        var icon = $('<i></i>').addClass('fas fa-pen'); 
                        button.append(icon);
                        listItem.append($('<td></td>').append(button));
                        $('#dataList').append(listItem);
                    });
                },
                error: function(xhr, status, error) {
                    console.error('Errore nella richiesta AJAX:', status, error);
                }
            });
        }

        $(document).ready(function() {
            fetchData();
        });

        function validateForm() {
            var name = document.getElementById('modalNome').value;
            var selectedCar = document.getElementById('selectedCar').value;;
            if (name.length > 20) {
            errorMessage = 'Il nome non può avere più di 20 caratteri.';
            document.getElementById('nameError').innerText = errorMessage;
            return false;
            }
            else{ document.getElementById('nameError').innerText = ''; }
            if (!selectedCar) {
                alert('Seleziona una colonnina prima di inviare il modulo.');
                return false; // blocca l'invio del modulo
            }
            return true; // consente l'invio del modulo
            }

        function checkDates() {
            var startDate = new Date(document.getElementById('modalInizio').value);
            var endDate = new Date(document.getElementById('modalFine').value);
            var today = new Date();
            var yesterday = new Date();
            yesterday.setDate(yesterday.getDate() - 1);
            clearSelection();

            var dateError = document.getElementById('dateError');

            if (startDate > endDate) {
                dateError.innerText = 'La data di inizio non può essere successiva alla data di fine';
            } else if (endDate - startDate > 30 * 24 * 60 * 60 * 1000) {
                dateError.innerText = 'La durata non può superare un mese';
            } else if (startDate < yesterday || endDate < yesterday ) {
                dateError.innerText = 'Le date non possono essere nel passato';
            } else {
                dateError.innerText = ''; // Clear error message
            }
        }
        // Funzione per rimuovere la selezione delle colonnine quando si cambia la data
        function clearSelection() {
            document.querySelectorAll('.car-icon').forEach(container => {
                container.classList.remove('selected');
            });

            document.getElementById('selectedCar').value = '';
        }

        // Funzione per ordinare e rimuovere i duplicati dall'array
        function sortAndRemoveDuplicates(array) {
            return [...new Set(array)].sort();
        }

        // Funzione per disabilitare le colonnine non disponibili
        function disableUnavailableCars(unavailableCars) {
            unavailableCars = sortAndRemoveDuplicates(unavailableCars);
            console.log(unavailableCars);
            document.querySelectorAll('.car-icon').forEach(function(carIcon) {
                var iconNumberElement = carIcon.querySelector('.icon-number');
                if (iconNumberElement) {
                    var carNumber = parseInt(iconNumberElement.textContent.trim(), 10);
                    if (unavailableCars.includes(carNumber)) {
                        carIcon.classList.add('unavailable');
                        carIcon.setAttribute('data-disponibile', 'false');
                        carIcon.classList.remove('selected');
                        carIcon.onclick = null;
                    } else {
                        carIcon.classList.remove('unavailable');
                        carIcon.setAttribute('data-disponibile', 'true');
                        carIcon.onclick = function() {
                        selectCar(carNumber);
                        };
                    }
                }
            });
        }



        // Funzione per selezionare una colonnina
        function selectCar(carNumber) {
            document.querySelectorAll('.car-icon').forEach(container => {
                container.classList.remove('selected');
            });

            document.querySelector(`.car-icon:nth-child(${carNumber})`).classList.add('selected');
            document.getElementById('selectedCar').value = carNumber;
        }

        // Funzione per inviare la richiesta AJAX
        function sendAjaxRequest() {
            let plate_tmp = document.getElementById('modalTarga').value;
            let start_tmp = document.getElementById('modalInizio').value;
            let end_tmp = document.getElementById('modalFine').value;

            $.ajax({
                type: 'POST',
                url: '/check_posti_modal',
                contentType:'application/json',
                data: JSON.stringify({plate:plate_tmp, data_arrivo: start_tmp, data_partenza: end_tmp}),
                success: function(response) {
                    console.log('Checkposti request inviata');
                    //$('#risultati_query').html("Le collonnine non disponibili sono: "+response);
                    var carsUnavailable = [];
                    //carsUnavailable = JSON.parse(response)
                    carsUnavailable = response;
                    disableUnavailableCars(carsUnavailable);
                },
                error: function(xhr, status, error) {
                    console.error('Errore nella richiesta AJAX:', status, error);
                }
            });
        }

        // Funzione per eseguire le operazioni quando si cambia la data di arrivo
        function onArrivalDateChange() {
            document.getElementById('modalInizio').value = '';
            sendAjaxRequest();
        }

        // Funzione per eseguire le operazioni quando si cambia la data di partenza
        function onDepartureDateChange() {
            document.getElementById('modalFine').value = '';
            sendAjaxRequest();
        }

        document.addEventListener('DOMContentLoaded', function() {
        document.getElementById('modalInizio').addEventListener('input', checkDates);
        document.getElementById('modalFine').addEventListener('input', checkDates);
        document.getElementById('modalInizio').addEventListener('input',sendAjaxRequest);
        document.getElementById('modalFine').addEventListener('input',sendAjaxRequest);
        });

        function sendDeleteRequest(plate) {
            plate_tmp = document.getElementById('modalTarga').value;
            console.log('sending delete request');
            $.ajax({
                type: 'POST',
                url: '/delete_targhe',
                contentType: 'application/json',
                data: JSON.stringify({ plate: plate_tmp }),
                success: function(response) {
                    console.log('Delete request inviata');
                    if(response.error){
                        console.error('errore nella richiesta ajax');
                        return;
                    }
                },
                error: function(xhr, status, error) {
                    console.error('Errore nella richiesta AJAX-Delete:', status, error);
                }
            });
        }
        function sendChangeRequest() {
            let plate_tmp = document.getElementById('modalTarga').value;
            let name_tmp =  document.getElementById('modalNome').value;
            let start_tmp = document.getElementById('modalInizio').value;
            let end_tmp = document.getElementById('modalFine').value;
            let place = document.getElementById('selectedCar').value;
            console.log('updating');

            $.ajax({
                type: 'POST',
                url: '/change_targhe',
                contentType:'application/json',
                data: JSON.stringify({name:name_tmp,plate: plate_tmp, data_arrivo: start_tmp, data_partenza:end_tmp, selectedCar:place}),
                success: function(response) {
                    console.log('Update request inviata');
                    if(response.error){
                        console.error('errore nella richiesta ajax');
                        return;
                    }
                },
                error: function(xhr, status, error) {
                    console.error('Errore nella richiesta AJAX-Update:', status, error);
                }
            });
            window.location.reload();
        }

        function showConfirmModal() {
        // Apri il mini modal di conferma
        $('#confirmModal').modal('show');
        }
        function confirmDelete() {
        // Chiudi il modal di conferma
        $('#confirmModal').modal('hide');
        
        // Chiamare la funzione di eliminazione qui, per esempio:
        sendDeleteRequest();
        
        // Chiudi anche il modal principale
        $('#editModal').modal('hide');
        window.location.reload();
        }
    </script>
    <!-- Modal -->
    <div class="modal fade" id="editModal" tabindex="-1" aria-labelledby="editModalLabel" aria-hidden="true">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="editModalLabel">Modifica Targa</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" onclick="clearSelection();disableUnavailableCars(carsUnavailable=[])" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <form action="" onsubmit="return validateform()">
                <div class="mb-3">
                  <label for="modalNome" class="form-label">Nome</label>
                  <input type="text" class="form-control" id="modalNome">
                </div>
                <div id="nameError" style="color: red;"></div>
                <div class="mb-3">
                  <label for="modalTarga" class="form-label">Targa</label>
                  <input type="text" class="form-control" id="modalTarga" readonly>
                </div>
                <div class="mb-3">
                  <label for="modalInizio" class="form-label">Inizio</label>
                  <input type="date" class="form-control" id="modalInizio">
                </div>
                <div class="mb-3">
                  <label for="modalFine" class="form-label">Fine</label>
                  <input type="date" class="form-control" id="modalFine">
                </div>
                <div id="dateError" style="color: red;"></div>
      
                <!-- Colonnina -->
                <div class="mb-3">
                  <label for="selectedCar" class="form-label">Colonnina</label>
                  <div class="d-flex flex-wrap"> <!-- Flex-wrap aggiunto per rendere le icone responsive -->
                    <div class="car-icon" data-disponibile="true">
                      <img src="car_icon.png" alt="Car 1" class="car-icon" onclick="selectCar(1)" style="width: 40px;">
                      <span class="icon-number">1</span>
                    </div>
                    <div class="car-icon" data-disponibile="true">
                      <img src="car_icon.png" alt="Car 2" class="car-icon" onclick="selectCar(2)" style="width: 40px;">
                      <span class="icon-number">2</span>
                    </div>
                    <!-- Altre icone mantenendo lo stesso stile -->
                    <div class="car-icon" data-disponibile="true">
                      <img src="car_icon.png" alt="Car 3" class="car-icon" onclick="selectCar(3)" style="width: 40px;">
                      <span class="icon-number">3</span>
                    </div>
                    <div class="car-icon" data-disponibile="true">
                      <img src="car_icon.png" alt="Car 4" class="car-icon" onclick="selectCar(4)" style="width: 40px;">
                      <span class="icon-number">4</span>
                    </div>
                    <div class="car-icon" data-disponibile="true">
                      <img src="car_icon.png" alt="Car 5" class="car-icon" onclick="selectCar(5)" style="width: 40px;">
                      <span class="icon-number">5</span>
                    </div>
                    <div class="car-icon" data-disponibile="true">
                      <img src="car_icon.png" alt="Car 6" class="car-icon" onclick="selectCar(6)" style="width: 40px;">
                      <span class="icon-number">6</span>
                    </div>
                    <div class="car-icon" data-disponibile="true">
                      <img src="car_icon.png" alt="Car 7" class="car-icon" onclick="selectCar(7)" style="width: 40px;">
                      <span class="icon-number">7</span>
                    </div>
                    <div class="car-icon" data-disponibile="true">
                      <img src="car_icon.png" alt="Car 8" class="car-icon" onclick="selectCar(8)" style="width: 40px;">
                      <span class="icon-number">8</span>
                    </div>
                  </div>
                  <input type="hidden" id="selectedCar" name="selectedCar" required>
                </div>
              </form>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-danger" data-bs-dismiss="modal" onclick="showConfirmModal();clearSelection();" >Elimina</button>
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" onclick="clearSelection();disableUnavailableCars(carsUnavailable=[])">Chiudi</button>
              <button type="button" class="btn btn-primary" onclick="validateForm();sendChangeRequest();clearSelection();">Salva Modifiche</button>
            </div>
          </div>
        </div>
      </div>
    </div>
    <!-- Mini modal di conferma -->
    <div class="modal fade" id="confirmModal" tabindex="-1" aria-labelledby="confirmModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="confirmModalLabel">Conferma Eliminazione</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    Sei sicuro di voler eliminare questa targa?
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" style='background-color: red;color:white;'data-bs-dismiss="modal">Annulla</button>
                    <button type="button" class="btn btn-danger" style='background-color: cadetblue; color:white;'' onclick="confirmDelete()">Conferma</button>
                </div>
            </div>
        </div>
    </div>
  </div>
  </body>
</html>